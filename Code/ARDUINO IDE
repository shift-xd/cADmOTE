#include <Arduino.h>
#include <Wire.h>
#include <ArduinoBLE.h>
#include "MPU6050_light.h"

// -------------------- MPU6050 --------------------
MPU6050 mpu(Wire);
unsigned long timer = 0;

// -------------------- BUTTON PINS --------------------
#define BTN_UP     2
#define BTN_DOWN   3
#define BTN_LEFT   4
#define BTN_RIGHT  5
#define BTN_OK     6

// -------------------- BLE SETUP --------------------
BLEService motionService("1234");

BLEStringCharacteristic motionData("ABCD",  // UUID
                                   BLERead | BLENotify,
                                   64);      // packet size

void setupButtons() {
  pinMode(BTN_UP,    INPUT_PULLUP);
  pinMode(BTN_DOWN,  INPUT_PULLUP);
  pinMode(BTN_LEFT,  INPUT_PULLUP);
  pinMode(BTN_RIGHT, INPUT_PULLUP);
  pinMode(BTN_OK,    INPUT_PULLUP);
}

void setup() {
  Serial.begin(115200);
  Wire.begin();

  // ---- MPU INIT ----
  mpu.begin();
  delay(300);
  mpu.calcOffsets(true, true);  // auto-calibrate

  // ---- BUTTON INIT ----
  setupButtons();

  // ---- BLE INIT ----
  if (!BLE.begin()) {
    Serial.println("BLE start failed!");
    while (1);
  }

  BLE.setLocalName("RP2040-MotionController");
  BLE.setAdvertisedService(motionService);

  motionService.addCharacteristic(motionData);
  BLE.addService(motionService);

  motionData.writeValue("{ready}");

  BLE.advertise();

  Serial.println("BLE Motion Controller Ready");
}

String getButtonStateJSON() {
  return String("{") +
    "\"up\":"    + String(!digitalRead(BTN_UP))    + "," +
    "\"down\":"  + String(!digitalRead(BTN_DOWN))  + "," +
    "\"left\":"  + String(!digitalRead(BTN_LEFT))  + "," +
    "\"right\":" + String(!digitalRead(BTN_RIGHT)) + "," +
    "\"ok\":"    + String(!digitalRead(BTN_OK))    +
  "}";
}

void loop() {
  BLEDevice central = BLE.central();

  if (central && central.connected()) {

    mpu.update();

    if (millis() - timer > 50) {   // send every 50ms
      timer = millis();

      String packet = "{";
      packet += "\"ax\":" + String(mpu.getAccX()) + ",";
      packet += "\"ay\":" + String(mpu.getAccY()) + ",";
      packet += "\"az\":" + String(mpu.getAccZ()) + ",";
      packet += "\"gx\":" + String(mpu.getGyroX()) + ",";
      packet += "\"gy\":" + String(mpu.getGyroY()) + ",";
      packet += "\"gz\":" + String(mpu.getGyroZ()) + ",";
      packet += "\"buttons\":" + getButtonStateJSON();
      packet += "}";

      motionData.writeValue(packet);
      Serial.println(packet);
    }
  }
}
